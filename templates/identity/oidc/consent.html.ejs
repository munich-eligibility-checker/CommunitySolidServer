<h1>Eine Anwendung fordert Zugriff an</h1>
<p class="error" id="error"></p>
<p>
  Vertrauen Sie dieser Anwendung,
  Daten in Ihrem Namen zu lesen und zu schreiben?
</p>
<div style="display: flex;">
  <img id="client_logo" width="40" height="40" style="margin-top: 1em; padding-left: 2em; visibility: collapse;">
  <dl id="client" style="text-wrap: nowrap;"></dl>
</div>
<form method="post" id="mainForm">
  <fieldset>
    <legend>Wählen Sie Ihre WebID zur Autorisierung</legend>
    <ol id="webIdList">
    </ol>
  </fieldset>

  <fieldset>
    <ol>
      <li class="checkbox">
        <label><input type="checkbox" name="remember" value="true" checked>Diese Anwendung merken</label>
      </li>
    </ol>
  </fieldset>

  <p class="actions">
    <button id="authorize" type="submit" disabled autofocus>Autorisieren</button>
    <button id="cancel" type="button">Abbrechen</button>
    <button id="edit-account" type="button" class="alternate">Konto bearbeiten</button>
    <button id="switch-account" type="button" class="alternate">Anderes Konto verwenden</button>
  </p>
</form>

<script>
  // Wire up elements
  const elements = getElements();

  // Retrieve and display client information
  (async() => {
    const controls = await fetchControls('<%= idpIndex %>');

    wireButtons(controls);

    const { webIds } = await fetchJson(controls.oidc.webId);
    if (webIds.length === 0) {
      setError('Diesem Konto sind keine WebIDs zugewiesen. Bearbeiten Sie das Konto, um eine hinzuzufügen.');
    }
    setVisibility('authorize', webIds.length > 0);

    // List WebIDs on page
    for (const webId of webIds) {
      webIdList.insertAdjacentHTML('beforeend', `
        <li class="radio">
          <label for="${webId}">
            <input id="${webId}" type="radio" name="webId" value="${webId}" ${webIds.length === 1 ? 'checked' : ''}>
            ${webId}
          </label>
        </li>`);
    }

    const { client } = await fetchJson(controls.oidc.consent);
    showClientInfo('Name', client.client_name);
    showClientInfo('Kennung', client.client_id);
    showClientLogo(client.logo_uri, `[${client.client_name} Logo]`);

    addPostListener(() => consent(controls));
  })();

  function wireButtons(controls) {
    elements.cancel.addEventListener('click', async() => {
      const res = await fetch(controls.oidc.cancel, { method: 'POST' });
      location.href = (await res.json()).location;
    });
    setRedirectClick('edit-account', controls.html.account.account);
    elements['switch-account'].addEventListener('click', async() => {
      await fetch(controls.account.logout, { method: 'POST' });
      location.href = controls.html.main.login;
    });
  }

  // Adds client info to the UI
  function showClientInfo(label, value) {
    if (value) {
      elements.client.insertAdjacentHTML('beforeend', `<dt>${label}</dt><dd>${value}</dd>`);
    }
  }

  // Attach client logo to placeholder img
  function showClientLogo(src, alt) {
    if (src) {
      elements.client_logo.src = src
      elements.client_logo.style.visibility = "visible"
    }
    if (alt) {
      elements.client_logo.alt = alt
    }
  }

  async function consent(controls) {
    // The OIDC provider does not allow us to login and consent at the same time, so these have to be separate calls
    const formData = new FormData(elements.mainForm);
    let res = await postJson(controls.oidc.webId, { webId: formData.get('webId') });
    let json = await res.json();
    if (res.status !== 200) {
      elements.error.innerText = json.message;
      return;
    }

    // This is required to update the OIDC interaction
    res = await fetch(json.location);
    if (res.status !== 200) {
      json = await res.json();
      elements.error.innerText = json.message;
      return;
    }

    // Submit to the consent API
    res = await postJson(controls.oidc.consent, { remember: Boolean(formData.get('remember')) });
    json = await res.json();
    if (res.status !== 200) {
      elements.error.innerText = json.message;
      return;
    }
    location.href = json.location;
  }
</script>
